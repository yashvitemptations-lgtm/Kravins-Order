<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<meta name="theme-color" content="#0b0d17">
<title>Distributor Portal ¬∑ Kravins</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0d17;--s1:#111320;--s2:#171a2e;--bdr:#252a45;
  --acc:#7c3aed;--a2:#a78bfa;
  --grn:#10b981;--org:#f59e0b;--red:#ef4444;--blu:#3b82f6;
  --txt:#f0f0ff;--mut:#6b7280;--sub:#9ca3af;
  --f:'Plus Jakarta Sans',sans-serif;--m:'JetBrains Mono',monospace
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:var(--f);background:var(--bg);color:var(--txt);min-height:100vh;overflow-x:hidden}
#setupScreen{position:fixed;inset:0;background:radial-gradient(ellipse at 30% 20%,rgba(124,58,237,.15) 0%,transparent 60%),var(--bg);z-index:1000;display:flex;align-items:center;justify-content:center;padding:24px}
.setup-box{width:100%;max-width:400px;text-align:center}
.setup-logo{width:64px;height:64px;border-radius:18px;background:linear-gradient(135deg,#7c3aed,#4f46e5);display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 20px;box-shadow:0 8px 32px rgba(124,58,237,.4)}
.setup-title{font-size:26px;font-weight:800;margin-bottom:6px;background:linear-gradient(135deg,#a78bfa,#818cf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.setup-sub{font-size:13px;color:var(--sub);margin-bottom:28px;line-height:1.7}
.setup-lbl{font-size:11px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--mut);margin-bottom:6px;text-align:left;display:block}
.setup-input{width:100%;background:var(--s2);border:1.5px solid var(--bdr);border-radius:10px;padding:13px 14px;font-family:var(--f);font-size:14px;color:var(--txt);outline:none;transition:border-color .2s;margin-bottom:14px}
.setup-input:focus{border-color:var(--acc)}
.setup-btn{width:100%;padding:14px;border-radius:10px;border:none;cursor:pointer;font-family:var(--f);font-size:14px;font-weight:700;background:linear-gradient(135deg,#7c3aed,#4f46e5);color:#fff;box-shadow:0 4px 20px rgba(124,58,237,.35);transition:all .2s}
.setup-btn:hover{transform:translateY(-1px)}
.setup-err{color:var(--red);font-size:12px;margin-bottom:12px;display:none}
/* Header */
.hdr{background:linear-gradient(180deg,var(--s1),rgba(17,19,32,.96));padding:14px 16px 0;border-bottom:1px solid var(--bdr);position:sticky;top:0;z-index:100;backdrop-filter:blur(16px)}
.htop{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.hinfo{display:flex;align-items:center;gap:10px}
.hav{width:40px;height:40px;border-radius:11px;background:linear-gradient(135deg,#7c3aed,#4f46e5);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:800;color:#fff}
.hname{font-size:15px;font-weight:700}
.hdid{font-size:10px;color:var(--a2);font-family:var(--m);margin-top:1px}
.hbtn{padding:6px 13px;border-radius:20px;font-size:11px;font-weight:600;cursor:pointer;border:none;font-family:var(--f)}
.hbtn.sync{background:rgba(16,185,129,.12);color:var(--grn);border:1px solid rgba(16,185,129,.25)}
.hbtn.out{background:rgba(107,114,128,.1);color:var(--sub);border:1px solid var(--bdr);margin-left:6px}
/* Tabs */
.tabs{display:flex;overflow-x:auto;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{flex-shrink:0;padding:10px 15px;font-size:11px;font-weight:700;color:var(--mut);border-bottom:2px solid transparent;cursor:pointer;transition:all .2s;white-space:nowrap;text-transform:uppercase;letter-spacing:.03em}
.tab.on{color:var(--a2);border-bottom-color:var(--acc)}
.badge{display:inline-flex;align-items:center;justify-content:center;min-width:16px;height:16px;padding:0 4px;border-radius:8px;font-size:9px;font-weight:800;margin-left:5px;background:var(--red);color:#fff;vertical-align:middle}
/* Pages */
.scr{padding-bottom:50px}
.page{display:none;animation:fadein .25s}.page.on{display:block}
@keyframes fadein{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.sec{padding:13px 15px 8px}
.sl{font-size:9px;font-weight:800;letter-spacing:.12em;text-transform:uppercase;color:var(--mut);margin-bottom:10px;display:flex;align-items:center;gap:8px}
.sl::after{content:'';flex:1;height:1px;background:var(--bdr)}
/* KPI */
.kg3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px}
.kcard{border-radius:13px;padding:12px 10px;position:relative;overflow:hidden;border:1px solid var(--bdr);background:linear-gradient(135deg,var(--s2),var(--s1))}
.kcard::before{content:'';position:absolute;top:-20px;right:-20px;width:70px;height:70px;border-radius:50%;filter:blur(28px);opacity:.2}
.kcard.or::before{background:var(--org)}.kcard.bl::before{background:var(--blu)}.kcard.gr::before{background:var(--grn)}.kcard.rd::before{background:var(--red)}
.kico{font-size:16px;margin-bottom:5px}
.kval{font-size:18px;font-weight:800;font-family:var(--m);line-height:1.1;margin-bottom:2px}
.klbl{font-size:9px;color:var(--mut);text-transform:uppercase;letter-spacing:.05em}
/* Order cards */
.ocard{background:var(--s1);border:1.5px solid var(--bdr);border-radius:13px;margin-bottom:9px;overflow:hidden;cursor:pointer;transition:border-color .2s}
.ocard:hover{border-color:var(--acc)}
.ocard-top{padding:12px 13px;display:flex;align-items:flex-start;gap:10px}
.status-ico{flex-shrink:0;width:36px;height:36px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:15px}
.status-ico.pending{background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.2)}
.status-ico.accepted{background:rgba(59,130,246,.12);border:1px solid rgba(59,130,246,.2)}
.status-ico.dispatched{background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.2)}
.status-ico.cancelled{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.12)}
.ocard-body{flex:1;min-width:0}
.ocard-r1{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.o-oid{font-family:var(--m);font-size:11px;font-weight:600;color:var(--a2)}
.o-amt{font-family:var(--m);font-size:14px;font-weight:800;color:var(--grn)}
.o-party{font-size:13px;font-weight:600;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.o-meta{font-size:10px;color:var(--sub);display:flex;gap:8px;flex-wrap:wrap}
.ocard-foot{padding:7px 13px;background:var(--s2);border-top:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between;font-size:10px}
.stbadge{display:inline-block;padding:2px 7px;border-radius:16px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.04em}
.stbadge.pending{background:rgba(245,158,11,.12);color:var(--org)}
.stbadge.accepted{background:rgba(59,130,246,.12);color:var(--blu)}
.stbadge.dispatched{background:rgba(16,185,129,.12);color:var(--grn)}
.stbadge.cancelled{background:rgba(239,68,68,.08);color:var(--red)}
/* Filters */
.fbar{display:flex;gap:7px;margin-bottom:10px;flex-wrap:wrap}
.fi{flex:1;min-width:120px;background:var(--s2);border:1.5px solid var(--bdr);border-radius:9px;padding:8px 10px;font-family:var(--f);font-size:12px;color:var(--txt);outline:none;-webkit-appearance:none}
.fi:focus{border-color:var(--acc)}
select.fi{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10'%3E%3Cpath fill='%236b7280' d='M5 7L0 2h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:26px}
/* Empty */
.empty{text-align:center;padding:42px 20px;color:var(--sub);font-size:13px;line-height:2}
.empty-ico{font-size:36px;display:block;margin-bottom:8px}
/* Modal */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);z-index:500;display:none;align-items:flex-end}
.ov.on{display:flex}
.mo{background:var(--s1);border-radius:20px 20px 0 0;border-top:1px solid var(--bdr);padding:18px 16px max(env(safe-area-inset-bottom,24px),24px);width:100%;max-height:92dvh;overflow-y:auto;animation:up .22s ease}
@keyframes up{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mhandle{width:36px;height:4px;background:var(--bdr);border-radius:2px;margin:0 auto 15px}
.mtitle{font-size:16px;font-weight:800;margin-bottom:3px}
.msub{font-size:11px;color:var(--sub);margin-bottom:14px}
/* Item edit rows */
.irow{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--bdr)}
.irow:last-child{border-bottom:none}
.iinfo{flex:1;min-width:0}
.iname{font-size:12px;font-weight:600;margin-bottom:2px}
.icode{font-size:10px;color:var(--a2);font-family:var(--m)}
.iorig{font-size:10px;color:var(--sub)}
.qty-in{width:70px;background:var(--s2);border:1.5px solid var(--bdr);border-radius:8px;padding:7px 8px;font-family:var(--m);font-size:13px;font-weight:700;color:var(--txt);outline:none;text-align:center}
.qty-in:focus{border-color:var(--acc)}
.itotal{font-family:var(--m);font-size:12px;font-weight:700;color:var(--a2);min-width:68px;text-align:right;flex-shrink:0}
/* Inforows */
.ir{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--bdr);font-size:12px}
.ir:last-child{border-bottom:none}
.irl{color:var(--sub)}.irv{font-weight:600;max-width:60%;text-align:right}
/* Dispatch form */
.dlbl{font-size:10px;font-weight:700;color:var(--mut);text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px;display:block;margin-top:12px}
.din{width:100%;background:var(--s2);border:1.5px solid var(--bdr);border-radius:9px;padding:10px 12px;font-family:var(--f);font-size:13px;color:var(--txt);outline:none}
.din:focus{border-color:var(--acc)}
.dgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
/* Buttons */
.btn{padding:12px 16px;border-radius:10px;font-family:var(--f);font-size:13px;font-weight:700;cursor:pointer;border:none;transition:all .15s;flex:1}
.btn:active{transform:scale(.97)}
.btn.primary{background:linear-gradient(135deg,#7c3aed,#4f46e5);color:#fff;box-shadow:0 4px 16px rgba(124,58,237,.3)}
.btn.success{background:linear-gradient(135deg,#059669,#047857);color:#fff;box-shadow:0 4px 16px rgba(5,150,105,.25)}
.btn.warn{background:rgba(245,158,11,.15);color:var(--org);border:1.5px solid rgba(245,158,11,.3)}
.btn.danger{background:rgba(239,68,68,.12);color:var(--red);border:1.5px solid rgba(239,68,68,.25)}
.btn.ghost{background:var(--s2);color:var(--sub);border:1.5px solid var(--bdr)}
.btn-row{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap}
/* Divider */
.mdiv{height:1px;background:var(--bdr);margin:14px 0}
/* Dispatch badge */
.disp-box{background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.18);border-radius:10px;padding:10px 12px;margin:10px 0}
.disp-title{font-size:11px;font-weight:800;color:var(--grn);margin-bottom:7px}
.disp-row{display:flex;justify-content:space-between;font-size:11px;padding:2px 0}
.disp-lbl{color:var(--sub)}.disp-val{font-family:var(--m);font-weight:600}
/* Audit */
.arow{padding:7px 0;border-bottom:1px solid var(--bdr);font-size:11px}
.arow:last-child{border-bottom:none}
.atag{display:inline-block;padding:1px 6px;border-radius:4px;font-size:9px;font-weight:800;margin-right:5px;font-family:var(--m);text-transform:uppercase}
.atag.SUBMIT{background:rgba(59,130,246,.1);color:var(--blu)}
.atag.ACCEPT,.atag.DIST_MODIFY{background:rgba(124,58,237,.1);color:var(--a2)}
.atag.DISPATCH,.atag.DISPATCH_UPDATE{background:rgba(16,185,129,.1);color:var(--grn)}
.atag.CANCEL,.atag.DIST_CANCEL{background:rgba(239,68,68,.08);color:var(--red)}
.atag.EDIT{background:rgba(245,158,11,.08);color:var(--org)}
/* SM cards */
.smrow{background:var(--s1);border:1px solid var(--bdr);border-radius:10px;padding:10px 12px;margin-bottom:7px;display:flex;align-items:center;gap:10px}
.smav{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:#fff;flex-shrink:0}
/* Toast */
.toast{position:fixed;top:72px;left:50%;transform:translateX(-50%) translateY(-10px);background:var(--s2);border:1px solid var(--bdr);border-radius:10px;padding:9px 18px;font-size:12px;font-weight:600;opacity:0;transition:all .25s;z-index:9999;pointer-events:none;box-shadow:0 8px 28px rgba(0,0,0,.5)}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.ok{border-color:rgba(16,185,129,.4);color:var(--grn)}
.toast.er{border-color:rgba(239,68,68,.4);color:var(--red)}
.toast.in{border-color:rgba(124,58,237,.4);color:var(--a2)}
</style>
</head>
<body>

<!-- Setup Screen -->
<div id="setupScreen">
  <div class="setup-box">
    <div class="setup-logo">üöö</div>
    <div class="setup-title">Distributor Portal</div>
    <div class="setup-sub">Enter your Distributor ID to access your orders dashboard.<br>Contact admin if you need your ID.</div>
    <span class="setup-lbl">Distributor ID</span>
    <input id="setupId" class="setup-input" placeholder="e.g. D001" autocomplete="off" oninput="this.value=this.value.toUpperCase()" onkeydown="if(event.key==='Enter')doSetup()">
    <div class="setup-err" id="setupErr">Distributor not found. Please check your ID.</div>
    <button class="setup-btn" onclick="doSetup()">Access My Portal ‚Üí</button>
  </div>
</div>

<!-- App -->
<div id="app" style="display:none">
  <div class="hdr">
    <div class="htop">
      <div class="hinfo">
        <div class="hav" id="hAv">D</div>
        <div>
          <div class="hname" id="hName">‚Äî</div>
          <div class="hdid" id="hId">‚Äî</div>
        </div>
      </div>
      <div>
        <button class="hbtn sync" onclick="loadData()">‚Üª Sync</button>
        <button class="hbtn out" onclick="doLogout()">Exit</button>
      </div>
    </div>
    <div class="tabs">
      <div class="tab on"  onclick="goTab('pending')">‚è≥ Pending<span class="badge" id="bPending" style="display:none">0</span></div>
      <div class="tab"     onclick="goTab('accepted')">‚úÖ Accepted</div>
      <div class="tab"     onclick="goTab('dispatched')">üì¶ Dispatched</div>
      <div class="tab"     onclick="goTab('all')">üìã All Orders</div>
      <div class="tab"     onclick="goTab('salesmen')">üë§ Salesmen</div>
    </div>
  </div>

  <div class="scr">

    <!-- PENDING -->
    <div class="page on" id="pg-pending">
      <div class="sec">
        <div class="kg3">
          <div class="kcard or"><div class="kico">‚è≥</div><div class="kval" id="k-p">0</div><div class="klbl">Pending</div></div>
          <div class="kcard bl"><div class="kico">‚úÖ</div><div class="kval" id="k-a">0</div><div class="klbl">Accepted</div></div>
          <div class="kcard gr"><div class="kico">üì¶</div><div class="kval" id="k-d">0</div><div class="klbl">Dispatched</div></div>
        </div>
        <div class="sl">Awaiting Your Action</div>
        <div id="pendingList"><div class="empty"><span class="empty-ico">üîÑ</span>Loading orders...</div></div>
      </div>
    </div>

    <!-- ACCEPTED -->
    <div class="page" id="pg-accepted">
      <div class="sec">
        <div class="sl">Accepted ‚Äî Ready to Dispatch</div>
        <div id="acceptedList"><div class="empty"><span class="empty-ico">‚úÖ</span>No accepted orders</div></div>
      </div>
    </div>

    <!-- DISPATCHED -->
    <div class="page" id="pg-dispatched">
      <div class="sec">
        <div class="sl">Dispatched Orders</div>
        <div id="dispatchedList"><div class="empty"><span class="empty-ico">üì¶</span>No dispatched orders yet</div></div>
      </div>
    </div>

    <!-- ALL -->
    <div class="page" id="pg-all">
      <div class="sec">
        <div class="fbar">
          <input class="fi" type="search" id="asearch" placeholder="Order, party, salesman..." oninput="renderAll()">
          <select class="fi" id="asmf" onchange="renderAll()"><option value="">All Salesmen</option></select>
          <select class="fi" id="astf" onchange="renderAll()">
            <option value="">All Status</option>
            <option>Pending</option><option>Accepted</option><option>Dispatched</option><option>Cancelled</option>
          </select>
        </div>
        <div class="sl">All Orders (<span id="allCnt">0</span>)</div>
        <div id="allList"></div>
      </div>
    </div>

    <!-- SALESMEN -->
    <div class="page" id="pg-salesmen">
      <div class="sec">
        <div class="sl">Salesmen Linked to You</div>
        <div id="smList"></div>
      </div>
    </div>

  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ORDER MODAL -->
<div class="ov" id="orderOv" onclick="if(event.target===this)closeModal()">
  <div class="mo">
    <div class="mhandle"></div>
    <div class="mtitle" id="om-title">Order</div>
    <div class="msub" id="om-sub"></div>
    <div id="om-details"></div>
    <div id="om-disp-info" style="display:none"></div>

    <!-- Accept/Modify -->
    <div id="sec-accept" style="display:none">
      <div class="mdiv"></div>
      <div class="sl">Accept / Adjust Quantities</div>
      <div id="accept-items"></div>
      <div style="display:flex;justify-content:space-between;padding:10px 0;border-top:1px solid var(--bdr);margin-top:4px">
        <span style="font-size:12px;color:var(--sub)">Accepted Total</span>
        <span id="accept-total" style="font-family:var(--m);font-size:16px;font-weight:800;color:var(--grn)">‚Çπ0</span>
      </div>
      <textarea id="accept-notes" class="fi" placeholder="Optional notes to salesman..." style="width:100%;resize:none;min-height:50px;margin-top:8px"></textarea>
      <div class="btn-row">
        <button class="btn success" onclick="submitAccept()">‚úÖ Accept Order</button>
        <button class="btn ghost" onclick="hideSec()">Cancel</button>
      </div>
    </div>

    <!-- Dispatch form -->
    <div id="sec-dispatch" style="display:none">
      <div class="mdiv"></div>
      <div class="sl" id="disp-sec-title">Dispatch Details</div>
      <div class="dgrid">
        <div>
          <label class="dlbl">Invoice No *</label>
          <input id="d-inv" class="din" placeholder="INV-2026-001">
        </div>
        <div>
          <label class="dlbl">Invoice Date *</label>
          <input id="d-invdate" class="din" type="date">
        </div>
      </div>
      <div class="dgrid">
        <div>
          <label class="dlbl">Dispatch Date</label>
          <input id="d-dispdate" class="din" type="date">
        </div>
        <div>
          <label class="dlbl">Transport / Courier</label>
          <input id="d-transport" class="din" placeholder="DTDC, vehicle, etc.">
        </div>
      </div>
      <label class="dlbl">Tracking / LR Number</label>
      <input id="d-tracking" class="din" placeholder="Optional">
      <label class="dlbl">Notes</label>
      <textarea id="d-notes" class="din" style="resize:none;min-height:50px;margin-bottom:0" placeholder="Optional..."></textarea>
      <div class="btn-row">
        <button class="btn success" id="dispBtn" onclick="submitDispatch()">üì¶ Confirm Dispatch</button>
        <button class="btn ghost" onclick="hideSec()">Cancel</button>
      </div>
    </div>

    <!-- Cancel -->
    <div id="sec-cancel" style="display:none">
      <div class="mdiv"></div>
      <div class="sl">Cancel Order</div>
      <textarea id="cancel-reason" class="fi" placeholder="Reason for cancellation..." style="width:100%;resize:none;min-height:58px"></textarea>
      <div class="btn-row">
        <button class="btn danger" onclick="submitCancel()">‚õî Confirm Cancel</button>
        <button class="btn ghost" onclick="hideSec()">Back</button>
      </div>
    </div>

    <!-- Action bar -->
    <div id="om-actions" class="btn-row" style="margin-top:16px;border-top:1px solid var(--bdr);padding-top:14px"></div>

    <!-- History -->
    <div id="audit-wrap" style="margin-top:14px;display:none">
      <div class="sl">Order History</div>
      <div id="audit-body"></div>
    </div>
  </div>
</div>

<script>
const SCRIPT_URL='https://script.google.com/macros/s/AKfycbz70y3yn3VHlpV1yFrLP0l5L3CduXtDoU0tl_TbBhzCnXQZlIrNoEm4DHgZkmbVIabg/exec';
const SM_COLORS=['#7c3aed','#3b82f6','#10b981','#f59e0b','#ec4899','#14b8a6','#f43f5e','#84cc16'];
let distId='',distName='',distInfo={};
let allOrders=[],allSalesmen=[];
let curOrder=null,dispMode='new';

const fi=n=>'‚Çπ'+Number(n||0).toLocaleString('en-IN');
function normDate(d){if(!d)return '';try{const dt=new Date(d);if(!isNaN(dt)){const i=new Date(dt.getTime()+330*60000);return i.toISOString().slice(0,10);}}catch(e){}return String(d).slice(0,10);}
function fmtDate(s){if(!s)return '‚Äî';try{return new Date(s+'T00:00:00').toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'});}catch(e){return s;}}
function fmtTs(s){if(!s)return '‚Äî';try{return new Date(s).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});}catch(e){return s;}}
let _tt;function toast(m,t='ok'){const el=document.getElementById('toast');clearTimeout(_tt);el.textContent=m;el.className=`toast ${t} on`;_tt=setTimeout(()=>el.classList.remove('on'),2800);}

document.addEventListener('DOMContentLoaded',()=>{
  const s=localStorage.getItem('kravins_dist_id');
  if(s){distId=s;initApp();}
  const today=new Date().toISOString().slice(0,10);
  document.getElementById('d-invdate').value=today;
  document.getElementById('d-dispdate').value=today;
});

async function doSetup(){
  const id=document.getElementById('setupId').value.trim().toUpperCase();
  if(!id){document.getElementById('setupErr').style.display='block';return;}
  try{
    const r=await fetch(`${SCRIPT_URL}?action=distributors&t=${Date.now()}`);
    const d=await r.json();
    const found=(d.distributors||[]).find(x=>x.id===id);
    if(!found){document.getElementById('setupErr').style.display='block';return;}
    document.getElementById('setupErr').style.display='none';
    distId=id;distInfo=found;distName=found.name;
    localStorage.setItem('kravins_dist_id',id);
    initApp();
  }catch(e){
    document.getElementById('setupErr').textContent='Connection error. Try again.';
    document.getElementById('setupErr').style.display='block';
  }
}
function doLogout(){localStorage.removeItem('kravins_dist_id');location.reload();}

async function initApp(){
  if(!distName){
    try{
      const r=await fetch(`${SCRIPT_URL}?action=distributors&t=${Date.now()}`);
      const d=await r.json();
      const f=(d.distributors||[]).find(x=>x.id===distId);
      if(!f){doLogout();return;}
      distInfo=f;distName=f.name;
    }catch(e){doLogout();return;}
  }
  document.getElementById('setupScreen').style.display='none';
  document.getElementById('app').style.display='block';
  const init=distName.split(' ').map(w=>w[0]).join('').slice(0,2);
  document.getElementById('hAv').textContent=init;
  document.getElementById('hName').textContent=distName;
  document.getElementById('hId').textContent=distId+(distInfo.territory?' ¬∑ '+distInfo.territory:'');
  await loadData();
}

async function loadData(){
  try{
    const [r1,r2]=await Promise.all([
      fetch(`${SCRIPT_URL}?action=orders&distId=${distId}&t=${Date.now()}`),
      fetch(`${SCRIPT_URL}?action=salesmen&t=${Date.now()}`)
    ]);
    const [od,sd]=await Promise.all([r1.json(),r2.json()]);
    if(od.ok) allOrders=(od.orders||[]).map(o=>({...o,date:normDate(o.date)}));
    if(sd.ok) allSalesmen=(sd.salesmen||[]).filter(s=>s.distributor===distId);
    // Update SM filter
    const opts=allSalesmen.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    document.getElementById('asmf').innerHTML='<option value="">All Salesmen</option>'+opts;
    renderViews();
    toast('‚úì Synced','ok');
  }catch(e){toast('‚ö†Ô∏è Sync failed','er');}
}

function goTab(tab){
  const tabs=['pending','accepted','dispatched','all','salesmen'];
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('on',tabs[i]===tab));
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
  document.getElementById('pg-'+tab).classList.add('on');
  if(tab==='all') renderAll();
  if(tab==='salesmen') renderSalesmen();
  window.scrollTo({top:0});
}

function renderViews(){
  const pend=allOrders.filter(o=>o.status==='Pending');
  const acc=allOrders.filter(o=>o.status==='Accepted');
  const disp=allOrders.filter(o=>o.status==='Dispatched');
  document.getElementById('k-p').textContent=pend.length;
  document.getElementById('k-a').textContent=acc.length;
  document.getElementById('k-d').textContent=disp.length;
  const b=document.getElementById('bPending');
  if(pend.length>0){b.textContent=pend.length;b.style.display='inline-flex';}else b.style.display='none';
  document.getElementById('pendingList').innerHTML=pend.length?pend.map(oCard).join(''):'<div class="empty"><span class="empty-ico">üéâ</span>All caught up! No pending orders.</div>';
  document.getElementById('acceptedList').innerHTML=acc.length?acc.map(oCard).join(''):'<div class="empty"><span class="empty-ico">üì≠</span>No accepted orders yet.</div>';
  document.getElementById('dispatchedList').innerHTML=disp.length?disp.map(oCard).join(''):'<div class="empty"><span class="empty-ico">üì¶</span>No dispatched orders yet.</div>';
  renderAll();renderSalesmen();
}

function oCard(o){
  const sc=o.status.toLowerCase();
  const ico=o.status==='Pending'?'‚è≥':o.status==='Accepted'?'‚úÖ':o.status==='Dispatched'?'üì¶':'‚úï';
  const items=(o.items||[]).slice(0,2).map(it=>`${it.code}√ó${it.acceptedQty||it.qty}`).join(', ')+(o.items.length>2?` +${o.items.length-2}`:'');
  const inv=o.status==='Dispatched'&&o.invoiceNo?`¬∑ ${o.invoiceNo}`:'';
  return `<div class="ocard" onclick="openOrder('${o.oid}')">
    <div class="ocard-top">
      <div class="status-ico ${sc}">${ico}</div>
      <div class="ocard-body">
        <div class="ocard-r1"><span class="o-oid">${o.oid}</span><span class="o-amt">${fi(o.gt)}</span></div>
        <div class="o-party">${o.bname}</div>
        <div class="o-meta">
          <span>üë§ ${o.smName}</span>
          <span>üìÖ ${fmtDate(o.date)}</span>
          ${o.baddress?`<span>üìç ${o.baddress.slice(0,22)}‚Ä¶</span>`:''}
        </div>
      </div>
    </div>
    <div class="ocard-foot">
      <span style="color:var(--sub)">${items}</span>
      <span><span class="stbadge ${sc}">${o.status}</span>${inv?`<span style="margin-left:5px;color:var(--sub);font-size:9px">${inv}</span>`:''}</span>
    </div>
  </div>`;
}

function renderAll(){
  const q=(document.getElementById('asearch')?.value||'').toLowerCase();
  const sf=document.getElementById('asmf')?.value||'';
  const tf=document.getElementById('astf')?.value||'';
  const f=allOrders.filter(o=>{
    const mq=!q||o.oid.toLowerCase().includes(q)||o.bname.toLowerCase().includes(q)||(o.smName||'').toLowerCase().includes(q);
    return mq&&(!sf||o.smId===sf)&&(!tf||o.status===tf);
  });
  document.getElementById('allCnt').textContent=f.length;
  document.getElementById('allList').innerHTML=f.map(oCard).join('')||'<div class="empty"><span class="empty-ico">üîç</span>No orders found</div>';
}

function renderSalesmen(){
  const SMC=['#7c3aed','#3b82f6','#10b981','#f59e0b','#ec4899'];
  document.getElementById('smList').innerHTML=allSalesmen.map((sm,i)=>{
    const orders=allOrders.filter(o=>o.smId===sm.id&&o.status!=='Cancelled').length;
    const pend=allOrders.filter(o=>o.smId===sm.id&&o.status==='Pending').length;
    const init=sm.name.split(' ').map(w=>w[0]).join('').slice(0,2);
    return `<div class="smrow">
      <div class="smav" style="background:${SMC[i%SMC.length]}">${init}</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:700">${sm.name}</div>
        <div style="font-size:10px;color:var(--sub)">${sm.id} ¬∑ ${sm.territory||'‚Äî'} ¬∑ Target: ${fi(sm.target||50000)}/mo</div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div style="font-family:var(--m);font-size:13px;font-weight:700;color:var(--a2)">${orders} orders</div>
        ${pend>0?`<div style="font-size:10px;color:var(--org)">${pend} pending</div>`:'<div style="font-size:10px;color:var(--grn)">‚úì Clear</div>'}
      </div>
    </div>`;
  }).join('')||'<div class="empty">No salesmen linked to your account.<br>Set the Distributor ID in Master_Salesmen sheet.</div>';
}

// ‚îÄ‚îÄ ORDER MODAL ‚îÄ‚îÄ
async function openOrder(oid){
  const o=allOrders.find(x=>x.oid===oid);
  if(!o) return;
  curOrder=o;
  ['sec-accept','sec-dispatch','sec-cancel','om-disp-info','audit-wrap'].forEach(id=>{
    document.getElementById(id).style.display='none';
  });
  document.getElementById('om-title').textContent=o.oid;
  document.getElementById('om-sub').textContent=`${o.bname} ¬∑ ${fmtDate(o.date)} ¬∑ ${o.smName}`;
  const sc=o.status.toLowerCase();
  let det=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:11px">
    <span class="stbadge ${sc}">${o.status}</span>
    <span style="font-size:11px;color:var(--sub)">Placed by ${o.smName} (${o.smId})</span>
  </div>`;
  det+=`<div style="background:var(--s2);border-radius:10px;padding:10px 12px;margin-bottom:11px">`;
  (o.items||[]).forEach(it=>{
    const aq=it.acceptedQty!==undefined?it.acceptedQty:it.qty;
    const mod=aq!=it.qty;
    det+=`<div class="ir">
      <span class="irl">${it.name} <span style="font-size:9px;font-family:var(--m);color:var(--a2)">${it.code}</span></span>
      <span class="irv" style="font-family:var(--m)">
        ${mod?`<span style="text-decoration:line-through;color:var(--sub);font-size:10px">${it.qty}</span> `:''}${aq} √ó ‚Çπ${it.price} = ${fi(aq*it.price)}
      </span>
    </div>`;
  });
  det+=`<div class="ir" style="border-top:2px solid var(--bdr);margin-top:5px;padding-top:8px">
    <span style="font-weight:700">Grand Total</span>
    <span style="font-family:var(--m);font-size:16px;font-weight:800;color:var(--grn)">${fi(o.gt)}</span>
  </div></div>`;
  if(o.bphone||o.baddress) det+=`<div style="font-size:11px;color:var(--sub);margin-bottom:10px">${o.bphone?`üì± ${o.bphone}<br>`:''}${o.baddress?`üìç ${o.baddress}`:''}</div>`;
  if(o.notes) det+=`<div style="background:rgba(124,58,237,.08);border:1px solid rgba(124,58,237,.15);border-radius:8px;padding:8px 10px;font-size:11px;color:var(--a2);margin-bottom:8px">üìù ${o.notes}</div>`;
  document.getElementById('om-details').innerHTML=det;
  // Dispatch info
  if(o.status==='Dispatched'&&(o.invoiceNo||o.dispatchDate)){
    let di=`<div class="disp-box"><div class="disp-title">üì¶ Dispatch Details</div>`;
    if(o.invoiceNo) di+=`<div class="disp-row"><span class="disp-lbl">Invoice No</span><span class="disp-val">${o.invoiceNo}</span></div>`;
    if(o.invoiceDate) di+=`<div class="disp-row"><span class="disp-lbl">Invoice Date</span><span class="disp-val">${fmtDate(o.invoiceDate)}</span></div>`;
    if(o.dispatchDate) di+=`<div class="disp-row"><span class="disp-lbl">Dispatch Date</span><span class="disp-val">${fmtDate(o.dispatchDate)}</span></div>`;
    if(o.transport) di+=`<div class="disp-row"><span class="disp-lbl">Transport</span><span class="disp-val">${o.transport}</span></div>`;
    if(o.trackingNo) di+=`<div class="disp-row"><span class="disp-lbl">Tracking/LR</span><span class="disp-val">${o.trackingNo}</span></div>`;
    if(o.dispatchNotes) di+=`<div class="disp-row"><span class="disp-lbl">Notes</span><span class="disp-val">${o.dispatchNotes}</span></div>`;
    di+='</div>';
    document.getElementById('om-disp-info').innerHTML=di;
    document.getElementById('om-disp-info').style.display='block';
  }
  // Actions
  let acts='';
  if(o.status==='Pending'){
    acts=`<button class="btn success" onclick="showAccept()">‚úÖ Accept / Adjust</button>
    <button class="btn danger" onclick="showSec('sec-cancel')">‚õî Cancel</button>`;
  }else if(o.status==='Accepted'){
    acts=`<button class="btn primary" onclick="showDispatch(false)">üì¶ Add Dispatch Details</button>
    <button class="btn warn" onclick="showAccept()">‚úèÔ∏è Modify Qty</button>
    <button class="btn danger" onclick="showSec('sec-cancel')">‚õî Cancel</button>`;
  }else if(o.status==='Dispatched'){
    acts=`<button class="btn warn" onclick="showDispatch(true)">‚úèÔ∏è Update Dispatch</button>`;
  }
  acts+=`<button class="btn ghost" onclick="document.getElementById('audit-wrap').style.display=document.getElementById('audit-wrap').style.display==='none'?'block':'none'">üìã History</button>`;
  document.getElementById('om-actions').innerHTML=acts;
  document.getElementById('orderOv').classList.add('on');
  loadAudit(oid);
}

async function loadAudit(oid){
  try{
    const r=await fetch(`${SCRIPT_URL}?action=auditLog&orderId=${oid}&t=${Date.now()}`);
    const d=await r.json();
    document.getElementById('audit-body').innerHTML=(d.logs||[]).length
      ?(d.logs||[]).map(l=>`<div class="arow"><span class="atag ${l.action}">${l.action.replace('_',' ')}</span>${l.details||''}<div style="color:var(--mut);font-size:10px;margin-top:2px">${l.actor} ¬∑ ${fmtTs(l.ts)}</div></div>`).join('')
      :'<div style="text-align:center;padding:12px;color:var(--sub);font-size:11px">No history yet</div>';
  }catch(e){}
}

function closeModal(){document.getElementById('orderOv').classList.remove('on');}
function hideSec(){['sec-accept','sec-dispatch','sec-cancel'].forEach(id=>document.getElementById(id).style.display='none');}
function showSec(id){hideSec();document.getElementById(id).style.display='block';setTimeout(()=>document.getElementById(id).scrollIntoView({behavior:'smooth'}),80);}

// Accept
function showAccept(){
  hideSec();document.getElementById('sec-accept').style.display='block';
  const o=curOrder;
  let h='';
  (o.items||[]).forEach(it=>{
    const aq=it.acceptedQty!==undefined?it.acceptedQty:it.qty;
    h+=`<div class="irow">
      <div class="iinfo"><div class="iname">${it.name}</div><div class="icode">${it.code} ¬∑ ‚Çπ${it.price}/unit</div><div class="iorig">Ordered: ${it.qty}</div></div>
      <input type="number" class="qty-in" id="aq-${it.code}" value="${aq}" min="0" oninput="updTotal()">
      <div class="itotal" id="at-${it.code}">${fi(aq*it.price)}</div>
    </div>`;
  });
  document.getElementById('accept-items').innerHTML=h;
  document.getElementById('accept-notes').value='';
  updTotal();
  setTimeout(()=>document.getElementById('sec-accept').scrollIntoView({behavior:'smooth'}),80);
}
function updTotal(){
  const o=curOrder;if(!o)return;
  let tot=0;
  (o.items||[]).forEach(it=>{
    const v=parseFloat(document.getElementById('aq-'+it.code)?.value)||0;
    tot+=v*it.price;
    const el=document.getElementById('at-'+it.code);
    if(el)el.textContent=fi(v*it.price);
  });
  document.getElementById('accept-total').textContent=fi(tot);
}
async function submitAccept(){
  const o=curOrder;if(!o)return;
  const qs={};
  (o.items||[]).forEach(it=>{const v=parseFloat(document.getElementById('aq-'+it.code)?.value);if(!isNaN(v))qs[it.code]=v;});
  const notes=document.getElementById('accept-notes').value;
  const btn=document.querySelector('#sec-accept .btn.success');
  btn.disabled=true;btn.textContent='Accepting‚Ä¶';
  try{
    await fetch(SCRIPT_URL,{method:'POST',headers:{'Content-Type':'text/plain'},
      body:JSON.stringify({action:'distModifyOrder',orderId:o.oid,distId,distName,acceptedQtys:qs,notes})});
    const idx=allOrders.findIndex(x=>x.oid===o.oid);
    if(idx>=0){allOrders[idx].status='Accepted';(allOrders[idx].items||[]).forEach(it=>{if(qs[it.code]!==undefined)it.acceptedQty=qs[it.code];});}
    toast('‚úÖ Order accepted!','ok');closeModal();renderViews();
  }catch(e){toast('‚ö†Ô∏è Error ‚Äî retry','er');}
  btn.disabled=false;btn.textContent='‚úÖ Accept Order';
}

// Dispatch
function showDispatch(isUpdate){
  dispMode=isUpdate?'update':'new';
  document.getElementById('disp-sec-title').textContent=isUpdate?'‚úèÔ∏è Update Dispatch Details':'üì¶ Dispatch Details';
  document.getElementById('dispBtn').textContent=isUpdate?'üíæ Update Dispatch':'üì¶ Confirm Dispatch';
  hideSec();document.getElementById('sec-dispatch').style.display='block';
  const today=new Date().toISOString().slice(0,10);
  const o=curOrder;
  if(isUpdate&&o){
    document.getElementById('d-inv').value=o.invoiceNo||'';
    document.getElementById('d-invdate').value=o.invoiceDate||today;
    document.getElementById('d-dispdate').value=o.dispatchDate||today;
    document.getElementById('d-transport').value=o.transport||'';
    document.getElementById('d-tracking').value=o.trackingNo||'';
    document.getElementById('d-notes').value=o.dispatchNotes||'';
  }else{
    ['d-inv','d-transport','d-tracking','d-notes'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('d-invdate').value=today;
    document.getElementById('d-dispdate').value=today;
  }
  setTimeout(()=>document.getElementById('sec-dispatch').scrollIntoView({behavior:'smooth'}),80);
}
async function submitDispatch(){
  const o=curOrder;if(!o)return;
  const inv=document.getElementById('d-inv').value.trim();
  if(!inv){toast('Invoice number required','er');return;}
  const dispatch={
    invoiceNo:inv,
    invoiceDate:document.getElementById('d-invdate').value,
    dispatchDate:document.getElementById('d-dispdate').value,
    transport:document.getElementById('d-transport').value.trim(),
    trackingNo:document.getElementById('d-tracking').value.trim(),
    notes:document.getElementById('d-notes').value.trim()
  };
  const btn=document.getElementById('dispBtn');
  btn.disabled=true;btn.textContent='Saving‚Ä¶';
  try{
    const action=dispMode==='update'?'updateDispatch':'saveDispatch';
    await fetch(SCRIPT_URL,{method:'POST',headers:{'Content-Type':'text/plain'},
      body:JSON.stringify({action,orderId:o.oid,distId,distName,dispatch})});
    const idx=allOrders.findIndex(x=>x.oid===o.oid);
    if(idx>=0){allOrders[idx].status='Dispatched';Object.assign(allOrders[idx],{invoiceNo:dispatch.invoiceNo,invoiceDate:dispatch.invoiceDate,transport:dispatch.transport,trackingNo:dispatch.trackingNo,dispatchDate:dispatch.dispatchDate,dispatchNotes:dispatch.notes});}
    toast(dispMode==='update'?'‚úèÔ∏è Dispatch updated!':'üì¶ Order dispatched!','ok');
    closeModal();renderViews();
  }catch(e){toast('‚ö†Ô∏è Error ‚Äî retry','er');}
  btn.disabled=false;btn.textContent=dispMode==='update'?'üíæ Update Dispatch':'üì¶ Confirm Dispatch';
}

// Cancel
async function submitCancel(){
  const o=curOrder;if(!o)return;
  const reason=document.getElementById('cancel-reason').value.trim();
  const btn=document.querySelector('#sec-cancel .btn.danger');
  btn.disabled=true;btn.textContent='Cancelling‚Ä¶';
  try{
    await fetch(SCRIPT_URL,{method:'POST',headers:{'Content-Type':'text/plain'},
      body:JSON.stringify({action:'distCancelOrder',orderId:o.oid,distId,distName,reason})});
    const idx=allOrders.findIndex(x=>x.oid===o.oid);
    if(idx>=0)allOrders[idx].status='Cancelled';
    toast('‚õî Order cancelled','er');closeModal();renderViews();
  }catch(e){toast('‚ö†Ô∏è Error ‚Äî retry','er');}
  btn.disabled=false;btn.textContent='‚õî Confirm Cancel';
}

setInterval(()=>{if(distId)loadData();},60000);
</script>
</body>
</html>
